{% extends "base.html" %}

{% block title %}Transactions - Finance App{% endblock %}

{% block content %}
<div class="row">
    <!-- Savings Goal Section -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Set Your Monthly Savings Goal</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('show_transactions') }}">
                    <div class="input-group mb-3">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" name="savings_goal" value="{{ savings_goal }}" min="0" step="1" required>
                        <button class="btn btn-primary" type="submit">Update Goal</button>
                    </div>
                </form>
                {% if goals and goals.time_estimate %}
                <div class="alert alert-info mt-3">
                    <i class="fas fa-clock me-2"></i>{{ goals.time_estimate }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Current Balances Section -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Savings Goal Progress</h5>
            </div>
            <div class="card-body">
                <h3 class="text-success">${{ "%.2f"|format(current_savings|default(0)) }}</h3>
                <div class="progress mb-2" style="height: 25px;">
                    <div class="progress-bar bg-success" role="progressbar" 
                         data-current="{{ current_savings|default(0) }}"
                         data-goal="{{ savings_goal }}"
                         aria-valuenow="{{ current_savings|default(0) }}" 
                         aria-valuemin="0" 
                         aria-valuemax="{{ savings_goal }}"
                         style="min-width: 2em;">
                    </div>
                </div>
                <p class="text-muted mb-0">Goal: ${{ "%.2f"|format(savings_goal) }}</p>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Emergency Fund</h5>
            </div>
            <div class="card-body">
                <h3 class="text-warning">${{ "%.2f"|format(emergency_fund|default(0)) }}</h3>
                <div class="progress mb-2" style="height: 25px;">
                    <div class="progress-bar bg-warning" role="progressbar" 
                         data-current="{{ emergency_fund|default(0) }}"
                         data-goal="{{ savings_goal * 0.5 }}"
                         aria-valuenow="{{ emergency_fund|default(0) }}" 
                         aria-valuemin="0" 
                         aria-valuemax="{{ savings_goal * 0.5 }}"
                         style="min-width: 2em;">
                    </div>
                </div>
                <p class="text-muted mb-0">Target: ${{ "%.2f"|format(savings_goal * 0.5) }}</p>
            </div>
        </div>
    </div>

    <!-- Daily Quests Section -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Daily Quests</h5>
            </div>
            <div class="card-body">
                {% if goals and goals.quests %}
                    {% for quest in goals.quests %}
                    <div class="quest-item mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="quest-title mb-0">{{ quest.title }}</h6>
                            <button class="btn btn-sm btn-success complete-quest" 
                                    data-quest-id="{{ loop.index0 }}"
                                    {% if quest.completed %}disabled{% endif %}>
                                <i class="fas fa-check me-1"></i>
                                {{ "Completed" if quest.completed else "Complete" }}
                            </button>
                        </div>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar" 
                                 role="progressbar" 
                                 data-completed="{{ 'true' if quest.completed else 'false' }}"
                                 aria-valuenow="{{ '100' if quest.completed else '0' }}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                        <p class="quest-details text-muted small">{{ quest.description }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No quests available. Start by setting a savings goal!</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Transactions Section -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Transactions</h5>
            </div>
            <div class="card-body">
                {% if transactions %}
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactions %}
                            <tr>
                                <td>{{ transaction.date }}</td>
                                <td>{{ transaction.name }}</td>
                                <td>{{ transaction.category[0] if transaction.category else 'Uncategorized' }}</td>
                                <td class="{{ 'text-success' if transaction.amount > 0 else 'text-danger' }}">
                                    ${{ '%0.2f'|format(transaction.amount|abs) }}
                                    {{ '+' if transaction.amount > 0 else '-' }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No transactions found for the last 30 days.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update progress bars
    document.querySelectorAll('.progress-bar').forEach(function(bar) {
        // Handle savings and emergency fund progress bars
        if (bar.hasAttribute('data-current')) {
            const current = parseFloat(bar.getAttribute('data-current')) || 0;
            const goal = parseFloat(bar.getAttribute('data-goal')) || 1;
            const progress = Math.min(100, (current / goal) * 100);
            
            bar.style.width = progress.toFixed(1) + '%';
            bar.setAttribute('aria-valuenow', progress.toFixed(1));
            bar.textContent = progress.toFixed(1) + '%';
        }
        // Handle quest progress bars
        else if (bar.hasAttribute('data-completed')) {
            const isCompleted = bar.getAttribute('data-completed') === 'true';
            bar.style.width = isCompleted ? '100%' : '0%';
            bar.setAttribute('aria-valuenow', isCompleted ? '100' : '0');
            bar.textContent = isCompleted ? '100%' : '0%';
        }
    });

    // Handle quest completion
    document.querySelectorAll('.complete-quest').forEach(function(button) {
        button.addEventListener('click', function() {
            const questId = this.getAttribute('data-quest-id');
            const button = this;
            
            // Make API call to complete quest
            fetch('/complete_quest', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ quest_id: parseInt(questId) })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Update button state
                    button.disabled = true;
                    button.innerHTML = '<i class="fas fa-check me-1"></i>Completed';
                    
                    // Update quest progress bar
                    const progressBar = button.closest('.quest-item').querySelector('.progress-bar');
                    progressBar.style.width = '100%';
                    progressBar.setAttribute('aria-valuenow', 100);
                    progressBar.textContent = '100%';
                    progressBar.setAttribute('data-completed', 'true');
                    
                    // Update balance amounts
                    document.querySelector('.text-success').textContent = '$' + parseFloat(data.current_savings).toFixed(2);
                    document.querySelector('.text-warning').textContent = '$' + parseFloat(data.emergency_fund).toFixed(2);
                    
                    // Update progress bars
                    const savingsProgress = document.querySelector('.card-header.bg-success').nextElementSibling.querySelector('.progress-bar');
                    const emergencyProgress = document.querySelector('.card-header.bg-warning').nextElementSibling.querySelector('.progress-bar');
                    const savingsGoal = parseFloat('{{ savings_goal }}');
                    
                    const savingsPercentage = Math.min(100, (data.current_savings / savingsGoal) * 100);
                    const emergencyPercentage = Math.min(100, (data.emergency_fund / (savingsGoal * 0.5)) * 100);
                    
                    savingsProgress.style.width = savingsPercentage.toFixed(1) + '%';
                    savingsProgress.textContent = savingsPercentage.toFixed(1) + '%';
                    savingsProgress.setAttribute('aria-valuenow', savingsPercentage.toFixed(1));
                    
                    emergencyProgress.style.width = emergencyPercentage.toFixed(1) + '%';
                    emergencyProgress.textContent = emergencyPercentage.toFixed(1) + '%';
                    emergencyProgress.setAttribute('aria-valuenow', emergencyPercentage.toFixed(1));
                } else {
                    alert('Failed to complete quest: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to complete quest. Please try again.');
            });
        });
    });
});
</script>
{% endblock %} 